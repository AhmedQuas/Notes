### Spis treści
- [Chapter 2: Securing Network Devices](#chapter-2-securing-network-devices)
  - [2.1 Securing Device Access](#21-securing-device-access)
    - [2.1.1 Password security](#211-password-security)
    - [2.1.2 Line access security](#212-line-access-security)
    - [2.1.3 Cisco login enhancements](#213-cisco-login-enhancements)
    - [2.1.4 SSH Configuration](#214-ssh-configuration)
  - [2.2 Assign administrative roles](#22-assign-administrative-roles)
    - [2.2.1 Privilege level](#221-privilege-level)
    - [2.2.2 Role based CLI](#222-role-based-cli)
    - [2.2.3 Configuring views](#223-configuring-views)
    - [2.2.4 Configuring superviews](#224-configuring-superviews)
    - [2.2.3 Verify Role-Base CLI view](#223-verify-role-base-cli-view)
  - [2.3 Cisco IOS Resilient Configuration feature](#23-cisco-ios-resilient-configuration-feature)
    - [2.3.1 Restore a primary bootser image](#231-restore-a-primary-bootser-image)
    - [2.3.2 SCP server config](#232-scp-server-config)
    - [2.3.3 Password recovery procedure](#233-password-recovery-procedure)
    - [2.3.4 Secure management and reporting](#234-secure-management-and-reporting)
  - [2.4 Automated security features](#24-automated-security-features)
  - [2.5 Securing the Control Plane](#25-securing-the-control-plane)

# Chapter 2: Securing Network Devices

## 2.1 Securing Device Access

Egde router security approaches:
- `single router` - single router connects the protected network to the Internet
- `defense-in-depth` - consis of 3 layers of defense:
  - edge router,
  - firewall,
  - internal router
- `DMZ` - demilitarized zone, a variant of defense-in-depth. DMZ can be used for servers that must be accessible from the Internet

Areas of router security:
- `physical`
  - place device in a secure locked room,
  - free of EMI(EM INterference),
  - fire suppression,
  - temperature and humidity controls,
  - install UPS
- `OS & config files`
  - configure with the maximum ammount of memory possible,
  - use latest, stable version of OS that meets the feature specifications
  - keep a secure copy of router OS images & config backups
- `hardening`
  - secure administrative control,
  - disable unused ports & interfaces - reduce the number of ways a device can be accessed,
  - disable unnecessary services

Secure administrative access:
- restrict device accessibility,
- log and account for all access,
- authenticate access,
- authorize actions,
- present legal notification,
- ensure the confidentiality of data

Network device can be accessed:
- `localy` - physical access, requires a direct connection to a console port. Local access is typically used for initial configuration of the device
- `remotely` - Telnet, SSH, HTTP(S), SNMP & aux. The computer can be on the local network or a remote network

>Configure and establish a VPN connection to the local network before connecting to a router management interface.

>On Cisco routers and many other systems, password-leading spaces are ignored but spaces after the first character are not ignored.

### 2.1.1 Password security

>By default, the password length minimum is `six` characters.

```
R1(config)# security passwords min-length {10}
```

>By default, with the exception of the  password generated by the `enable secret` command, all Cisco router passwords are stored in plaintext in the router startup and running configuration files.

```
R1(config)# service password-encryption
```

But encryption is easily reversed with the right tool, so this command should not be used with the intention of protecting configuration files from serious attacks.

By default, an administrative interface stays active and logged in for `10 minutes` after the last session activity.

```
R1(config)# live vty 0 4
R1(config-line)# exec-timeout {min sec}
```

Use `no exec` to disable the EXEC process for specific line

Password algorithms types:
- `0` - unencrypted password,
- `5` - MD5,
- `7` - HIDDEN,
- `8` - PBKDF2 + SHA256,
- `9` - SCRYPT, slightly stronger than PBKDF2,

```
R1(config)# enable algorithm-type {md5|scrypt|sha256} secret {unencrypted_password}
```

```
R1(config)# username Bob secret {cisco1234}
R1(config)# username Bob algorithm-type {scrypt} secret {cisco1234}
```

>For backwards compatibility reasons, the `enable password`, `username password`, and `line password` commands are available in the Cisco IOS.

### 2.1.2 Line access security

>The password command configured on the console, vty, and auxiliary lines can only use type 7. Therefore, you should configure the console and auxiliary lines for username/password authentication with the `login local` command.

```
R1(config)# username Bob algorithm-type scrypt secret cisco1234
R1(config)# line con 0
R1(config-line)# login local
```

### 2.1.3 Cisco login enhancements

Virtual Login Security Enhancements:
- implement delays between successive login attempts,
- enable login shutdown if DoS attacks are suspected,
- generate system-logging messages for login detection

>All other login enhancement `features are disabled` until the login block-for command is configured.

Login block works in two modes:
- `normal mode`, watch mode - outer keeps count of the number of failed login attempts within an identified amount of time,
- `quiet mode`, quiet perioid - if the number of failed logins exceeds the configured threshold, all login attempts are denied for the time specified in the login block-for

Defend against DoS attack by disabling logins after specified number of failed login attempts. All `other login enhancement` features are `disabled until the login block-for` command is configured.

```
R1(config)# login block-for 15 attempts 5 within 60
```

`login quiet-mode access-class` - only the hosts identified in the ACL have access to the device during `quiet mode`.

Maps to an ACL that identifies the permited hosts. This ensures that only authorized hosts can attempt to login to the router.

```
R1(config)# login quiet-mode access-class {ACL-NAME}
```

Default login delay is 1 second. The delay occurs for all login attempts including failed or successful attempts.

```
R1(config)# login delay 10
```

Logging failed attempts - generate syslog messages

```
R1(config)# login on-success log {ever login, 65 535}
R1(config)# login on-failure log {ever login}
R1(config)# security authentication failure rate {threshold-rate} log
```

Configured to generate a log message when the login failure rate is exceeded.

>These login enhancements do not apply to console connections. When dealing with console connections, it is assumed that only authorized personnel have physical access to the devices.

```
R1# show login
R1# show login failures
```

### 2.1.4 SSH Configuration

Requirements the device must meet before configuring ssh:
- IOS that supports SSH,
- uses a unique hostname,
- contains domain-name,
- configured for local authentication or AAA services

```
Router(config)# hostname R1
R1(config)# ip domain-name ccna-security.com
R1(config)# crypto key generate rsa general-keys modulus 1024
R1(config)# username Admin algorithm-type scrypt secret cisco123
R1(config)# ip ssh version 2
R1(config)# ip ssh time-out SEC
R1(config)# ip ssh authentication-retries INT

R1(config)# line vty 0 4
R1(config-line)# login local
R1(config-line)# transport input ssh
```

Remove all ssh keys

```
R1# show crypto key mypubkey rsa
R1# conf t
R1(config)# crypto key reoize rsa
```

Show commands

```
R1# show crypto key mypubkey rsa
R1# show ip shh

#show sessions
R1# show ssh
```

## 2.2 Assign administrative roles

Methods of providing infrastructure access:
- `privilege level`,
- `role based CLI` - provides more granularity and control, it enables the network administrator to create different views of router configurations for different users.

By default Cisco CLI has two levels of access to commands:
- `user exec mode` - privilege level 1
- `privileged exec mode` - privilege level 15

Level 0 - disable, enable, exit, help, logout

```
R1(config)# privilege level {0-15} command
R1(config)# privilege reset command
```

### 2.2.1 Privilege level

Methods of assiging passwords to the different privilege levels.

```
R1(config)# privilege exec level 5 ping
R1(config)# username Support privilege 5 secret PASSWORD 
```

```
R1(config)# privilege exec level 5 ping
R1(config)# enable algorithm-type scrypt secret level 5 PASSWORD

R1> enable 5
R1# show privilege
R1# ping
#command not found
R1# reload
```

Limitation of privilege levels:
- no access control to specific interfaces, ports, logical interfaces, and slots on a router,
- commands available at lower privilege levels are always executable at higher levels,
- commands specifically set at a higher privilege level are not available for lower privileged users,
- assigning a command with multiple keywords allows access to all commands that use those keywords. For example, allowing access to show ip route allows the user access to all show and show ip commands.

### 2.2.2 Role based CLI

Types of views:
- `root view` - can configure any view for system,
- `CLI view` - contains specific set of commands,
- `Superview` - consist of one or more CLI views 

### 2.2.3 Configuring views

```
R1(config)# aaa new-model
R1(config)# parser view SHOWVIEW
R1(config-view)# secret cisco
R1(config-view)# commands exec include show
```

### 2.2.4 Configuring superviews

```
R1(config)# parser view VIEW-NAME superview
R1(config-view)# secret cisco
R1(config-view)# view SHOWVIEW
R1(config-view)# view PINGER
```

### 2.2.3 Verify Role-Base CLI view

```
R1(config)# enable view VIEW-NAME
R1# ?

#List all views/superviews* present in system
R1# enable view {default:root}
R1# show parser view all
```

\* - The asterisk identifies superviews

## 2.3 Cisco IOS Resilient Configuration feature

>The feature maintains a secure working copy of the router IOS image file and a copy of the running configuration file. These secure files cannot be removed by the user and are referred to as the primary bootset. Feature allows for faster recovery if someone maliciously or unintentionally reformats flash memory or erases the startup configuration file in nonvolatile random-access memory (NVRAM).

Technology is only avaiable for systems that support a PCMCIA Advanced Technology Attachment(ATA) flash interface.

```
R1(config)# secure boot-image
R1(config)# secure boot-config

R1# show secure bootset
```

>You can use the secure boot-config command repeatedly to upgrade the configuration archive to a newer version after new configuration commands have been issued.

>Secured files do not appear in the output of a `dir` command that is issued from the CLI. This is because the Cisco IOS file system prevents secure files from being listed. Use the `show secure bootset` command to verify the existence of the archive, as shown in the figure.

### 2.3.1 Restore a primary bootser image

```
R1# reload
<issue break sequence, if necessary>

rommon> dir flash0:
rommon> boot flash0:file_name

Router# secure boot-config restore flash:config_file_name
Router# copy flash0:config_file_name running-config
```

### 2.3.2 SCP server config

```
R1(config)# ip domain-name ccna-security.com
R1(config)# crypto key generate rsa general-keys modulus 2048
R1(config)# username Admin privilege 15 algorithm-type scrypt secret cisco123

R1(config)# aaa new model
R1(config)# aaa authentication login default local
R1(config)# aaa authorizaion exec default local

R1(config)# ip scp server enable
```

```
R2# copy flash:r2Backup.cfg scp:
```

### 2.3.3 Password recovery procedure

>Password recovery requires the administrator to have physical access to the router through a console cable. Depending on the device, the detailed procedure for password recovery varies.

1. Connects to the console port
2. Record the configuration register setting
3. Power cycle the router
4. Issuse the break sequence
5. Change the default cofniguration register with the `confreg 0x2142` command
6. Reboot the router
7. Press `Ctrl-C` to skip the initial setup procedure
8. Put the router into privileged EXEC mode
9. Copy startup configuration to the running configuration
10. Verify the configuration
11. Change enable secret password
12. Enable all interfaces
13. Return the configuration register to the oroginal setting recorded from step2. Use the `config-register` global config command
14. Save the configuration changes

Disable access to ROMmon mode

```
R1(config)# no service password-recovery
```

>When the router is booted, the initial boot sequence displays a message stating PASSWORD RECOVERY FUNCTIONALITY IS DISABLED.

>To recover a device after the no service password-recovery command is entered, initiate the break sequence within five seconds after the image decompresses during the boot. You are prompted to confirm the break key action. After the action is confirmed, the startup configuration is completely erased, the password recovery procedure is enabled, and the router boots with the factory default configuration.

### 2.3.4 Secure management and reporting

Type of management access:
- `in-band` - information flows across an enterprise production network, the Internet or both
- `out-of-band` - oob, information flows on a dedicated management network on which no production traffic resides. OOB management is appropriate for large enterprise networks.

>Management devices should be set up in a fashion that prevents direct communication with other hosts on the same management subnet by using separate LAN segments or VLANs.

Syslog - 514/udp, RFC 5424

Syslog provides functions such as:
- the ability to gather logging information for monitoring and troubleshooting
- the ability to select the type of logging information that is captured
- the ability to specify the destinations of captured syslog messages

Syslog destinations:
- logging buffer,
- console,
- terminal lines,
- syslog server

Syslog types of system:
- syslog servers,
- syslog clients 

```
R1(config)# logging host IP_ADDR
R1(config)# logging trap LEVEL
R1(config)# logging source-interface f0/20
R1(config)# logging on
```

SNMP - 161(agent),162(manager)/udp

Elements in SNMP system:
- SNMP manager,
- SNMP agent(management node),
- MIB - Management Information Base

SNMP versions:
- `v1` - Defined in RFC 1157; provided no authentication or encryption mechanism
- `v2c` - Defined in RFCs 1901 to 1908; improved upon SNMPv1 but provided no authentication or encryption mechanism
- `v3` - Defined in RFCs 2273 to 2275; provides secure access to devices by authenticating and encrypting packets over the network. V3 provides given security features:
  - message integrity and authentication
  - encryption
  - access control

>SNMP is vulnerable to attack precisely because SNMP agents can be polled with `get requests` and accept configuration changes with `set requests`.

Secure SNMP

```
R1(config)# snmp-server view VIEW_NAME OID_TREE
R1(config)# snmp-server group GROUP_NAME v3
R1(config)# priv read VIEW_NAME access ACL_NAME_NUMER
R1(config)# snmp-server user USERNAME GROUP_NAME v3 auth sha auth-password PRIV aes 256 PRIV_PASSOWRD 
```

>Configuring a view is required to limit SNMP messages to read-only access.

```
R1(config)# show snmp user
```

Time & NTP

NTP - 123/udp, RFC 1305

```
R1# clock set 10:15:00 MAR 31 2021
R1(config)# ntp master 1
R1(config)# ntp authenticate
R1(config)# ntp authentication-key 1 md5 cisco123
R1(config)# ntp trusted-key 1

R2(config)# ntp server 192.168.1.1
R2(config)# ntp authenticate
R2(config)# ntp authentication-key 1 md5 cisco123
R2(config)# ntp trusted-key 1

R2# show ntp associations detail
```

Disable CPD(Cisco Discovery Protocol) & LLDP(Link Layer Discovery Protocol, open standard)

```
R1# show cdp neighbours detail
```

## 2.4 Automated security features

__Default status of Services__

>`Cisco Autosecure` - feature that is initiated from the CLI and executes a script. AutoSecure first makes recommendations for fixing security vulnerabilities and then modifies the security configuration of the router, as shown in the figure.

Autosecure parameters:
- no-interact,
- full,
- forwarding,
- management,
- ntp,
- login,
- ssh,
- firewall,
- tcp-intercept

## 2.5 Securing the Control Plane

Consequences of spoofed routing information:
- redirecting traffic to create routing loops,
- redirecting traffic so it can be monitored on an insecure link
- redirecting traffic to discard it

Generic Threats to Routing Protocols - RFC 4593

OSPF SHA Authentication

```
R1(config)# key chain NAME
R1(config-keychain)# key KEY_ID
R1(config-keychain-key)# key-string STRING
R1(config-keychain-key)# cryptographic-algorithm hmac-sha256
R1(config)# send-lifetime

R1(config-if)# ip ospf authentication key-chain NAME
```

Network packet types:
- data plane packets,
- control plane packets - OSPF, ARP, BGP,
- management plane packets - SNMP, SSH, Telnet, NTP

>Under normal network operating conditions, the vast majority of packets handled by network devices are data plane packets. These packets are handled by Cisco Express Forwarding (CEF).

>Control Plane Policing (`CoPP`) is a Cisco IOS feature designed to allow administrators to manage the flow of traffic that is “punted” to the route processor.

CoPP protects the route processor on network devices by treating router processor resources as a separate entity with its own interface.

Areas of router security to maintain:
- physical security,
- router hardening,
- operating system security

---

<div>
<a href="chapter-01.md">Prev: Chapter 1</a>
</div>
<div align="right">
<a href="chapter-03.md">Next: Chapter 3</a>
</div>

